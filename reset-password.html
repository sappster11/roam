<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password | Roam Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-cream: #FDFCF8;
            --bg-black: #050505;
            --accent-orange: #EB5E28;
            --border-light: rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-cream);
            color: var(--bg-black);
            -webkit-font-smoothing: antialiased;
        }

        .main-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .form-wrapper {
            width: 100%;
            max-width: 480px;
            background: transparent;
            position: relative;
        }

        .input-group { margin-bottom: 1.25rem; }
        .input-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #666;
            margin-bottom: 0.5rem;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 0.375rem;
            font-size: 0.95rem;
            transition: all 0.2s;
            background: #fff;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 3px rgba(235, 94, 40, 0.1);
        }
        .input-field.error {
            border-color: #EF4444;
            background-color: #FEF2F2;
        }

        .btn-login {
            width: 100%;
            background-color: var(--accent-orange);
            color: white;
            padding: 0.875rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.2s;
            margin-top: 1rem;
        }
        .btn-login:hover {
            background-color: #cf4f1f;
            transform: translateY(-1px);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.04em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2.5rem;
            color: var(--bg-black);
            text-decoration: none;
        }
        .logo-dot { width: 12px; height: 12px; background: var(--accent-orange); border-radius: 50%; }

        .back-link {
            position: absolute;
            top: -3rem;
            left: 0;
            font-size: 0.875rem;
            color: #888;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }
        .back-link:hover { color: var(--bg-black); }

        .error-text {
            color: #EF4444;
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .success-state {
            display: none;
            text-align: center;
        }
        .success-icon {
            width: 64px;
            height: 64px;
            background: #ECFDF5;
            color: #059669;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto 1.5rem auto;
        }
    </style>
</head>
<body>

    <div class="main-container">
        
        <div class="form-wrapper">
            <a href="login.html" class="back-link">
                &larr; Back to Login
            </a>

            <div class="text-center">
                <a href="main.html" class="logo">
                    <span class="logo-dot"></span>
                    Roam.
                </a>
            </div>

            <!-- Reset Form -->
            <div id="reset-form-container">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold mb-2">Reset Password</h1>
                    <p class="text-gray-500">Enter your new security key below.</p>
                </div>

                <form onsubmit="handleReset(event)">
                    <div class="input-group relative group">
                        <label class="input-label" for="password">New Password</label>
                        <input type="password" id="password" class="input-field" placeholder="Create new password" required>
                        
                        <!-- Password Requirements Tooltip -->
                        <div id="password-tooltip" class="absolute top-full left-0 mt-2 w-full bg-white p-4 rounded-lg shadow-[0_10px_40px_-10px_rgba(0,0,0,0.2)] border border-gray-100 transform transition-all duration-300 opacity-0 invisible translate-y-2 z-20">
                            <div class="absolute -top-2 left-4 w-4 h-4 bg-white border-t border-l border-gray-100 transform rotate-45"></div>
                            <h4 class="text-xs font-bold text-gray-900 uppercase tracking-wider mb-2">Requirements</h4>
                            <ul class="text-xs text-gray-500 space-y-2">
                                <li id="req-length" class="flex items-center gap-2 transition-colors duration-200">
                                    <div class="w-4 flex justify-center"><i class="fa-regular fa-circle text-[10px]"></i></div> 8+ characters
                                </li>
                                <li id="req-number" class="flex items-center gap-2 transition-colors duration-200">
                                    <div class="w-4 flex justify-center"><i class="fa-regular fa-circle text-[10px]"></i></div> At least 1 number
                                </li>
                                <li id="req-upper" class="flex items-center gap-2 transition-colors duration-200">
                                    <div class="w-4 flex justify-center"><i class="fa-regular fa-circle text-[10px]"></i></div> 1 uppercase letter
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label" for="confirm-password">Confirm New Password</label>
                        <input type="password" id="confirm-password" class="input-field" placeholder="Confirm new password" required>
                        <p id="password-error" class="error-text">Passwords do not match</p>
                    </div>

                    <button type="submit" class="btn-login">Update Password</button>
                </form>
            </div>

            <!-- Success State (Hidden by default) -->
            <div id="success-message" class="success-state">
                <div class="success-icon">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h2 class="text-2xl font-bold mb-4">Password Updated</h2>
                <p class="text-gray-600 mb-8 leading-relaxed">
                    Your security key has been successfully reset. You can now log in with your new password.
                </p>
                <a href="login.html" class="btn-login inline-block w-auto px-8">Go to Login</a>
            </div>

        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://rtmewagtvmubpushnzag.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0bWV3YWd0dm11YnB1c2huemFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNDM2OTgsImV4cCI6MjA4MDgxOTY5OH0.jIdiAKJW4SUhAjOx-qw1g4EL8eMWsnhD_e9fqX8QUUs'
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey)

        // Elements
        const passwordInput = document.getElementById('password');
        const confirmInput = document.getElementById('confirm-password');
        const errorText = document.getElementById('password-error');
        const tooltip = document.getElementById('password-tooltip');

        // Requirement List Items
        const reqLength = document.getElementById('req-length');
        const reqNumber = document.getElementById('req-number');
        const reqUpper = document.getElementById('req-upper');

        // Helper: Update validation UI for a single requirement
        function updateRequirement(element, isValid) {
            const icon = element.querySelector('i');
            if (isValid) {
                element.classList.remove('text-gray-500');
                element.classList.add('text-green-600', 'font-medium');
                icon.className = 'fa-solid fa-check text-[10px]';
            } else {
                element.classList.add('text-gray-500');
                element.classList.remove('text-green-600', 'font-medium');
                icon.className = 'fa-regular fa-circle text-[10px]';
            }
        }

        // Logic: Check password strength
        function validateStrength() {
            const val = passwordInput.value;
            
            const isLength = val.length >= 8;
            const isNumber = /\d/.test(val);
            const isUpper = /[A-Z]/.test(val);

            updateRequirement(reqLength, isLength);
            updateRequirement(reqNumber, isNumber);
            updateRequirement(reqUpper, isUpper);

            return isLength && isNumber && isUpper;
        }

        // Logic: Check if passwords match
        function validateMatch() {
            const p1 = passwordInput.value;
            const p2 = confirmInput.value;
            
            if (p2 && p1 !== p2) {
                errorText.style.display = 'block';
                confirmInput.classList.add('error');
            } else {
                errorText.style.display = 'none';
                confirmInput.classList.remove('error');
            }
        }

        // Tooltip Visibility Logic
        passwordInput.addEventListener('focus', () => {
            tooltip.classList.remove('opacity-0', 'invisible', 'translate-y-2');
            tooltip.classList.add('opacity-100', 'visible', 'translate-y-0');
        });

        passwordInput.addEventListener('blur', () => {
            tooltip.classList.add('opacity-0', 'invisible', 'translate-y-2');
            tooltip.classList.remove('opacity-100', 'visible', 'translate-y-0');
        });

        // Event Listeners
        passwordInput.addEventListener('input', () => {
            validateStrength();
            if (confirmInput.value) validateMatch();
        });
        
        confirmInput.addEventListener('input', validateMatch);

        // Submit Handler
        async function handleReset(e) {
            e.preventDefault();
            
            const password = passwordInput.value;
            const confirmPassword = confirmInput.value;
            const btn = document.querySelector('.btn-login');

            // 1. Strict Requirement Check
            if (!validateStrength()) {
                alert("Please ensure your password meets all requirements: 8+ chars, 1 number, 1 uppercase.");
                passwordInput.focus();
                return;
            }

            // 2. Strict Match Check
            if (password !== confirmPassword) {
                errorText.style.display = 'block';
                confirmInput.classList.add('error');
                confirmInput.focus();
                return;
            }

            btn.textContent = 'Updating...';
            btn.style.opacity = '0.7';

            // 3. Update Password in Supabase
            const { data, error } = await _supabase.auth.updateUser({
                password: password
            });

            if (error) {
                alert("Error: " + error.message);
                btn.textContent = 'Update Password';
                btn.style.opacity = '1';
            } else {
                // 4. Show Success State
                document.getElementById('reset-form-container').style.display = 'none';
                document.getElementById('success-message').style.display = 'block';
            }
        }
    </script>

</body>
</html>
