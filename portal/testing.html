<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing Tracker | Roam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/portal-styles.css">
    <style>
        /* --- PAGE-SPECIFIC TABLE STYLES --- */
        .table-container {
            overflow: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
            height: 100%;
        }
        
        .tracker-table {
            width: max-content;
            min-width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .tracker-table th {
            background: #f9fafb;
            color: #374151;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 20;
            box-shadow: 0 1px 0 #e5e7eb;
        }

        .tracker-table td {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
            background-color: #fff;
            color: #1f2937;
            font-size: 0.85rem;
        }

        .section-header td {
            font-weight: 800;
            font-size: 0.85rem;
            padding: 0.75rem 1.5rem;
            border-top: 1px solid;
            border-bottom: 1px solid;
            border-left: 4px solid;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            left: 0;
            z-index: 15;
        }

        .section-draft td {
            background-color: #f3f4f6; 
            color: #4b5563; 
            border-color: #e5e7eb; 
            border-left-color: #9ca3af; 
        }

        .section-active td {
            background-color: #fff7ed; 
            color: #9a3412; 
            border-color: #fed7aa; 
            border-left-color: var(--accent-orange); 
        }

        .section-completed td {
            background-color: #f0fdf4; 
            color: #166534; 
            border-color: #bbf7d0; 
            border-left-color: #22c55e; 
        }

        .data-text {
            font-size: 0.85rem;
            color: #111;
            line-height: 1.5;
        }
        .data-sub {
            font-size: 0.75rem;
            color: #6b7280;
        }
        .text-strong { font-weight: 600; }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }
        .stat-label { color: #9ca3af; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; width: 30px; }
        .stat-val { font-weight: 600; color: #374151; font-family: monospace; }
        .stat-cr { color: #2563eb; font-weight: 700; }

        .badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .badge-placement { background-color: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }
        .badge-kpi { background-color: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; }
        
        .tooltip-container {
            position: relative;
            display: inline-flex;
            margin-left: 0.25rem;
            color: #9ca3af;
            cursor: help;
        }
        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 0.375rem;
            padding: 0.75rem;
            position: absolute;
            z-index: 50; 
            top: 150%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.75rem;
            font-weight: 400;
            text-transform: none;
            line-height: 1.4;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            white-space: normal;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent #1f2937 transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .calc-box {
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            background: #fafafa;
            border: 1px solid #e5e7eb;
        }
        .calc-stat { display: flex; justify-content: space-between; margin-bottom: 0.25rem; }
        .calc-stat span:last-child { font-weight: 700; }
        
        .sig-badge {
            display: block;
            text-align: center;
            padding: 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }
        .sig-green { background: #dcfce7; color: #15803d; }
        .sig-yellow { background: #fef9c3; color: #a16207; }
        .sig-red { background: #fee2e2; color: #b91c1c; }
        .sig-gray { background: #f3f4f6; color: #6b7280; }
    </style>
</head>
<body data-page="testing">

    <!-- Nav loads automatically via portal-nav.js -->

    <!-- Main Content -->
    <main class="flex flex-col h-screen pt-8 px-8"> 
        
        <div class="mobile-header">
            <div class="flex items-center gap-4">
                <button onclick="toggleMobileSidebar()" class="text-black text-xl p-1"><i class="fa-solid fa-bars"></i></button>
                <span class="text-xl font-bold tracking-tight text-black">Roam.</span>
            </div>
        </div>

        <header class="desktop-header">
            <div>
                <h1 class="text-3xl font-bold text-black">Testing Tracker</h1>
                <p class="text-xs text-gray-500 mt-1">Live results synced from Master_Data_Source.csv</p>
            </div>
            <div class="flex items-center gap-4 h-10">
                <div class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-md shadow-sm" title="Sync Status: Active">
                    <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.5)] animate-pulse"></div>
                    <span class="text-xs font-bold text-gray-600">Automatic Sync Enabled</span>
                </div>
                <button class="px-4 h-full bg-black text-white rounded text-sm font-bold hover:bg-gray-800 transition-colors shadow-sm flex items-center">
                    <i class="fa-solid fa-plus mr-2"></i> New Test
                </button>
            </div>
        </header>

        <!-- Testing Tracker Table -->
        <div class="flex-grow overflow-hidden pb-6">
            <div class="table-container">
                <table class="tracker-table">
                    <thead>
                        <tr>
                            <th class="w-48">
                                Date Range 
                                <span class="tooltip-container"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">The duration the test has been active in market.</span></span>
                            </th>
                            <th class="w-64">
                                Test Name 
                                <span class="tooltip-container"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Experiment identifier.</span></span>
                            </th>
                            <th class="w-16 text-center">
                                Vars 
                                <span class="tooltip-container"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Total variations including Control.</span></span>
                            </th>
                            <th class="w-80">
                                Hypothesis 
                                <span class="tooltip-container"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">The expected outcome being tested against.</span></span>
                            </th>
                            <th class="w-32">
                                Placement 
                                <span class="tooltip-container"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Channel or location of the test.</span></span>
                            </th>
                            <th class="w-24">
                                KPI 
                                <span class="tooltip-container"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Primary success metric.</span></span>
                            </th>
                            <th class="w-24">
                                Sample 
                                <span class="tooltip-container"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Total participants (N).</span></span>
                            </th>
                            <th class="w-32 bg-gray-50 border-l border-gray-200">
                                Control (A) 
                                <span class="tooltip-container"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Baseline data. V = Visitors/Recipients, C = Conversions.</span></span>
                            </th>
                            <th class="w-32 bg-gray-50">
                                Variant (B) 
                                <span class="tooltip-container"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Variation 1 metrics.</span></span>
                            </th>
                            <th class="w-32 bg-gray-50">
                                Variant (C) 
                                <span class="tooltip-container"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Variation 2 metrics.</span></span>
                            </th>
                            <th class="w-32 bg-gray-50 border-r border-gray-200">
                                Variant (D) 
                                <span class="tooltip-container"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Variation 3 metrics.</span></span>
                            </th>
                            <th class="w-64">
                                Significance 
                                <span class="tooltip-container"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Statistical confidence based on Z-score comparison of Best Variant vs Control.</span></span>
                            </th>
                            <th class="w-16 text-center">Link</th>
                        </tr>
                    </thead>
                    <tbody id="trackerBody"></tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- Shared Navigation -->
    <script src="/portal-nav.js"></script>

    <!-- Page-specific scripts -->
    <script>
        const sections = ['Draft', 'Active', 'Completed']; 
        
        const tests = [
            {
                id: 1,
                status: 'Draft',
                startDate: 'Dec 01, 2025',
                endDate: 'Dec 31, 2025',
                name: 'Welcome Series Offer',
                variants: 2,
                hypothesis: 'A fixed dollar amount ($10 off) will convert better than a percentage (10% off) for AOV under $100.',
                placement: 'Pop-up/Form',
                kpi: 'Sign-up Rate',
                sample: 0,
                control: { visitors: 0, conversions: 0 },
                variantB: { visitors: 0, conversions: 0 },
                link: '#'
            },
            {
                id: 2,
                status: 'Active', 
                startDate: 'Nov 01, 2025',
                endDate: 'Nov 15, 2025',
                name: 'Checkout Button Color',
                variants: 2,
                hypothesis: 'Switching the checkout button from black to green will increase click-through rate by at least 5% due to higher contrast.',
                placement: 'Campaign',
                kpi: 'Click Rate',
                sample: 5000,
                control: { visitors: 2500, conversions: 120 },
                variantB: { visitors: 2500, conversions: 150 },
                link: '#'
            },
            {
                id: 3,
                status: 'Completed',
                startDate: 'Oct 01, 2025',
                endDate: 'Oct 15, 2025',
                name: 'Subject Line Emoji Test',
                variants: 3,
                hypothesis: 'Including an emoji in the subject line will drive higher open rates for younger demographics.',
                placement: 'Flow',
                kpi: 'Open Rate',
                sample: 120,
                control: { visitors: 40, conversions: 5 },
                variantB: { visitors: 40, conversions: 8 },
                variantC: { visitors: 40, conversions: 4 },
                link: '#'
            }
        ];

        function renderTable() {
            const tbody = document.getElementById('trackerBody');
            tbody.innerHTML = '';

            sections.forEach(section => {
                const headerRow = document.createElement('tr');
                let sectionClass = '';
                if (section === 'Draft') sectionClass = 'section-draft';
                else if (section === 'Active') sectionClass = 'section-active';
                else if (section === 'Completed') sectionClass = 'section-completed';
                
                headerRow.className = `section-header ${sectionClass}`;
                headerRow.innerHTML = `<td colspan="13">${section} Tests</td>`;
                tbody.appendChild(headerRow);

                const items = tests.filter(t => t.status === section);
                
                if (items.length === 0) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = `<td colspan="13" class="text-center text-gray-400 py-4 italic">No tests in this stage</td>`;
                    tbody.appendChild(emptyRow);
                }

                items.forEach(test => {
                    const row = document.createElement('tr');
                    row.className = 'group hover:bg-gray-50';
                    row.setAttribute('data-id', test.id);
                    
                    const calcResult = calculateSignificance(test);
                    const hasC = test.variants >= 3;
                    const hasD = test.variants >= 4;

                    row.innerHTML = `
                        <td>
                            <div class="data-text font-medium">${test.startDate}</div>
                            <div class="data-sub">${test.endDate}</div>
                        </td>
                        <td>
                            <div class="data-text text-strong">${test.name}</div>
                        </td>
                        <td class="text-center">
                            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-100 text-xs font-bold text-gray-600">${test.variants}</span>
                        </td>
                        <td>
                            <p class="data-text text-gray-600 leading-relaxed text-xs">${test.hypothesis}</p>
                        </td>
                        <td>
                            <span class="badge badge-placement">${test.placement}</span>
                        </td>
                        <td>
                            <span class="badge badge-kpi">${test.kpi}</span>
                        </td>
                        <td>
                            <span class="data-text font-mono text-gray-600">${test.sample.toLocaleString()}</span>
                        </td>
                        <td class="bg-gray-50 border-l border-gray-200">
                            ${renderStats(test.control)}
                        </td>
                        <td class="bg-gray-50">
                            ${renderStats(test.variantB)}
                        </td>
                        <td class="bg-gray-50">
                            ${hasC ? renderStats(test.variantC) : '<span class="text-xs text-gray-300">-</span>'}
                        </td>
                        <td class="bg-gray-50 border-r border-gray-200">
                            ${hasD ? renderStats(test.variantD) : '<span class="text-xs text-gray-300">-</span>'}
                        </td>
                        <td>
                            ${calcResult}
                        </td>
                        <td class="text-center pt-6">
                            <a href="${test.link}" target="_blank" class="text-gray-400 hover:text-black transition-colors"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        function renderStats(data) {
            if(!data || (data.visitors === 0 && data.conversions === 0)) return '<span class="text-xs text-gray-400 italic">No Data</span>';
            const rate = data.visitors > 0 ? ((data.conversions / data.visitors) * 100).toFixed(2) + '%' : '0.00%';
            return `
                <div class="stat-row"><span class="stat-label">Vis</span> <span class="stat-val">${data.visitors.toLocaleString()}</span></div>
                <div class="stat-row"><span class="stat-label">Conv</span> <span class="stat-val">${data.conversions.toLocaleString()}</span></div>
                <div class="stat-row mt-1 pt-1 border-t border-gray-200"><span class="stat-label text-black">CR</span> <span class="stat-val stat-cr">${rate}</span></div>
            `;
        }

        function calculateSignificance(test) {
            if (!test.control.visitors || test.control.visitors === 0) {
                return '<div class="text-xs text-gray-400 italic text-center mt-2">Waiting for data...</div>';
            }

            const nA = test.control.visitors;
            const cA = test.control.conversions;
            
            const variants = [
                { name: 'B', n: test.variantB?.visitors || 0, c: test.variantB?.conversions || 0 },
                { name: 'C', n: test.variantC?.visitors || 0, c: test.variantC?.conversions || 0 },
                { name: 'D', n: test.variantD?.visitors || 0, c: test.variantD?.conversions || 0 }
            ];

            let bestVar = null;
            let bestCR = -1;

            variants.forEach(v => {
                if (v.n > 0) {
                    const cr = v.c / v.n;
                    if (cr > bestCR) {
                        bestCR = cr;
                        bestVar = v;
                    }
                }
            });

            if (bestVar && bestVar.n > 0) {
                const crA = cA / nA;
                const crB = bestVar.c / bestVar.n;
                const lift = ((crB - crA) / crA) * 100;
                const pPool = (cA + bestVar.c) / (nA + bestVar.n);
                const se = Math.sqrt(pPool * (1 - pPool) * ((1/nA) + (1/bestVar.n)));
                let z = 0;
                if(se > 0) z = (crB - crA) / se;

                function GetZPercent(z) {
                    if (z < -6.5) return 0;
                    if (z > 6.5) return 1;
                    var factK = 1, sum = 0, term = 1, k = 0, loopStop = Math.exp(-23);
                    while(Math.abs(term) > loopStop) {
                        term = .3989422804 * Math.pow(-1,k) * Math.pow(z,k) / (2 * k + 1) / Math.pow(2,k) * Math.pow(z,k+1);
                        sum += term;
                        k++;
                        factK *= k;
                    }
                    sum += 0.5;
                    return sum;
                }
                
                let probability = GetZPercent(z) * 100;
                
                let badgeClass = 'sig-gray';
                let badgeText = 'Not Significant';
                
                if (probability > 95) {
                    badgeClass = 'sig-green';
                    badgeText = 'Significant';
                } else if (probability >= 90) {
                    badgeClass = 'sig-yellow';
                    badgeText = 'Close';
                } else {
                    badgeClass = 'sig-red';
                    badgeText = 'Not Significant';
                }

                return `
                    <div class="calc-box">
                        <div class="calc-stat text-gray-500"><span>Best:</span> <span class="text-black">Var ${bestVar.name}</span></div>
                        <div class="calc-stat text-gray-500"><span>Lift:</span> <span class="${lift >= 0 ? 'text-green-600' : 'text-red-600'}">${lift > 0 ? '+' : ''}${lift.toFixed(1)}%</span></div>
                        <div class="calc-stat text-gray-500"><span>Conf:</span> <span class="text-black">${probability.toFixed(1)}%</span></div>
                    </div>
                    <span class="sig-badge ${badgeClass}">${badgeText}</span>
                `;
            }
            
            return '<div class="text-xs text-gray-400 italic text-center mt-2">Insufficient data</div>';
        }

        renderTable();
    </script>
</body>
</html>
